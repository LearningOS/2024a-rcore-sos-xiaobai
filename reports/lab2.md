# 实验实现的功能
> - 本次实验实现了以下功能：  
sys_get_time：用于获取当前时间，包括秒和微秒。
首先，通过get_time_us方法获取微秒数。接着，利用TimeVal结构体存储秒和微秒。最关键的步骤是，采用序列化的方法，将TimeVal结构体转换成字节数组，并复制到用户空间。  
sys_task_info：获取当前任务的信息。
首先，获取任务的系统调用次数和已运行时间的数据。然后，使用TaskInfo结构体整合这些数据。与sys_get_time类似，采用序列化的方法，将TaskInfo结构体转换为字节数组，并复制到用户空间。  
sys_mmap：在虚拟内存中映射一块区域。
首先，检查地址对齐和port有效性。然后，计算映射的结束地址，并根据port设置页表标志。在映射过程中，遍历要映射的虚拟页号范围，并根据页表进行映射。  
sys_munmap：取消虚拟内存中的映射。
首先，检查地址是否对齐，然后获取当前任务信息。接着，计算要取消映射的虚拟页号范围，并在页表中进行取消映射操作。
 

# 简答作业
### SV39 页表项的组成及标志位作用

在 RISC-V 的 SV39 页表中，每个页表项（PTE）是一个 64 位的值，包含以下字段：

- **PPN (Physical Page Number)**：物理页号，用于指向物理内存中的页。
- **RSW (Reserved for Software)**：保留给软件使用的位。
- **D (Dirty)**：脏位，表示该页是否被写入过。
- **A (Accessed)**：访问位，表示该页是否被访问过。
- **G (Global)**：全局位，表示该页是否在所有地址空间中都是全局的。
- **U (User)**：用户位，表示该页是否可以在用户模式下访问。
- **X (Execute)**：执行位，表示该页是否可执行。
- **W (Write)**：写位，表示该页是否可写。
- **R (Read)**：读位，表示该页是否可读。
- **V (Valid)**：有效位，表示该页表项是否有效。

### 标志位作用

- **D (Dirty)**：如果设置，则表示该页被写入过。用于写回缓存或交换时判断是否需要将页写回到磁盘。
- **A (Accessed)**：如果设置，则表示该页被访问过。用于页面置换算法判断页面的使用频率。
- **G (Global)**：如果设置，则表示该页在所有地址空间中都是全局的，不会在上下文切换时被刷新。
- **U (User)**：如果设置，则表示该页可以在用户模式下访问。用于区分用户态和内核态的页面。
- **X (Execute)**：如果设置，则表示该页可以执行。用于控制页面的执行权限。
- **W (Write)**：如果设置，则表示该页可以写入。用于控制页面的写权限。
- **R (Read)**：如果设置，则表示该页可以读取。用于控制页面的读权限。
- **V (Valid)**：如果设置，则表示该页表项有效。无效的页表项会导致页错误异常。

### 缺页

缺页指的是进程访问页面时页面不在页表中或在页表中无效的现象，此时 MMU 将会返回一个中断，告知操作系统进程内存访问出了问题。操作系统选择填补页表并重新执行异常指令或者杀死进程。

#### 哪些异常可能是缺页导致的？

- 页错误异常（Page Fault）
- 非法指令异常（Illegal Instruction）

#### 发生缺页时，描述相关重要寄存器的值

- **`stval`**：保存导致异常的虚拟地址。
- **`sepc`**：保存导致异常的指令地址。
- **`scause`**：保存异常的原因代码。

### Lazy 策略的好处

- **减少内存占用**：只有在页面被实际访问时才分配内存，减少了不必要的内存分配。
- **提高性能**：避免了在进程启动时大量的内存分配操作，延迟到实际需要时再进行。

#### 处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存？

- 10G 内存大约需要 2,560,000 个 4KB 页。
- 每个页表项 8 字节，三级页表大约需要 20MB 内存。

#### 如何实现 Lazy 策略，缺页时如何处理？

- **实现 Lazy 策略**：在内存分配时只记录需要分配的虚拟地址范围，不实际分配物理内存。只有在页面被访问时才分配物理内存。
- **缺页处理**：在缺页异常处理程序中，分配所需的物理内存，并更新页表项，使其指向新分配的物理内存。

### Swap 策略

#### 页面失效如何表现在页表项（PTE）上？

- **V (Valid) 位清零**：表示该页表项无效。
- **其他标志位可能被清除**：如 D 位和 A 位。

### 双页表与单页表

#### 单页表情况下，如何更换页表？

- 通过修改 `satp` 寄存器来更换页表。

#### 单页表情况下，如何控制用户态无法访问内核页面？

- 通过设置页表项中的 U 位，确保内核页面在用户态不可访问。

#### 单页表的优势

- **减少上下文切换开销**：不需要频繁更换页表。
- **简单性**：实现和管理相对简单。

#### 双页表实现下，何时需要更换页表？

- 在用户态和内核态切换时需要更换页表。
- 在进程切换时需要更换页表。

#### 单页表操作系统中，何时更换页表？

- 在进程切换时更换页表。
- 在进入内核态时不需要更换页表，只需设置页表项的权限。

 

# 荣誉准则
1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

    > 交流的对象：chatgpt-4o / github copilot  
    交流的内容：rust的语法，汇编指令，寄存器的作用，异常处理，上下文切换等知识。

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

    >参考书籍：[Detail Book rCore-Tutorial-Book-v3](https://rcore-os.cn/rCore-Tutorial-Book-v3/chapter0/1what-is-os.html)

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。